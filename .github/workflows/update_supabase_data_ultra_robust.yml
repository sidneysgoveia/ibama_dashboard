name: ðŸŒ³ AtualizaÃ§Ã£o IBAMA - Schema Corrigido
on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo com erros menores'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Ativar modo debug detalhado'
        required: false
        default: 'false'
        type: boolean
  
  schedule:
    - cron: '0 13 * * *'  # 13:00 UTC = 10:00 BRT

jobs:
  update-data-corrected:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ðŸ“¦ Instalar dependÃªncias otimizadas
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir pandas==2.2.3 supabase==2.5.0 requests==2.32.3 urllib3==2.2.2
          
      - name: ðŸ” Verificar ferramentas de sistema
        run: |
          echo "ðŸ”§ Verificando ferramentas disponÃ­veis:"
          which wget && echo "âœ… wget: $(wget --version | head -1)" || echo "âŒ wget nÃ£o disponÃ­vel"
          which curl && echo "âœ… curl: $(curl --version | head -1)" || echo "âŒ curl nÃ£o disponÃ­vel"
          
          echo "ðŸŒ Testando conectividade:"
          ping -c 3 dadosabertos.ibama.gov.br || echo "âš ï¸ Ping falhou"
          
      - name: ðŸ” Debug - Verificar Supabase Schema
        if: ${{ inputs.debug_mode == 'true' }}
        run: |
          python -c "
          import os
          from supabase import create_client
          
          try:
              supabase = create_client('${{ secrets.SUPABASE_URL }}', '${{ secrets.SUPABASE_KEY }}')
              result = supabase.table('ibama_infracao').select('*').limit(1).execute()
              
              if result.data:
                  columns = list(result.data[0].keys())
                  print(f'ðŸ“Š Colunas no Supabase ({len(columns)}):')
                  for i, col in enumerate(columns, 1):
                      print(f'{i:2d}. {col}')
              else:
                  print('âš ï¸ Tabela vazia - criando estrutura...')
          except Exception as e:
              print(f'âŒ Erro ao verificar schema: {e}')
          "
        env:
          PYTHONPATH: .
          
      - name: ðŸš€ Executar upload corrigido
        run: python upload_to_supabase_ultra_robust.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          IBAMA_ZIP_URL: 'https://dadosabertos.ibama.gov.br/dados/SIFISC/auto_infracao/auto_infracao/auto_infracao_csv.zip'
          DEBUG_MODE: ${{ inputs.debug_mode }}
          
      - name: ðŸ“Š Verificar dados apÃ³s upload
        if: success()
        run: |
          python -c "
          from supabase import create_client
          
          try:
              supabase = create_client('${{ secrets.SUPABASE_URL }}', '${{ secrets.SUPABASE_KEY }}')
              
              # Conta total
              result = supabase.table('ibama_infracao').select('*', count='exact').limit(1).execute()
              total = getattr(result, 'count', 0)
              
              # Conta Ãºnicos por NUM_AUTO_INFRACAO
              if total > 0:
                  print(f'âœ… Upload finalizado:')
                  print(f'   ðŸ“Š Total de registros: {total:,}')
                  
                  # Verifica amostra
                  sample = supabase.table('ibama_infracao').select('NUM_AUTO_INFRACAO, UF, TIPO_INFRACAO').limit(5).execute()
                  if sample.data:
                      print(f'   ðŸ” Amostra dos dados:')
                      for i, record in enumerate(sample.data, 1):
                          print(f'   {i}. {record.get(\"NUM_AUTO_INFRACAO\", \"N/A\")} - {record.get(\"UF\", \"N/A\")} - {record.get(\"TIPO_INFRACAO\", \"N/A\")}')
              else:
                  print('âŒ Nenhum registro encontrado apÃ³s upload')
                  
          except Exception as e:
              print(f'âŒ Erro na verificaÃ§Ã£o: {e}')
          "
        env:
          PYTHONPATH: .
          
      - name: ðŸ“‹ Upload de logs de execuÃ§Ã£o
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ibama-upload-logs-${{ github.run_number }}
          path: |
            *.log
            **/*.log
            debug_*.txt
          retention-days: 14
          
      - name: âœ… NotificaÃ§Ã£o de sucesso
        if: success()
        run: |
          echo "ðŸŽ‰ ========================================="
          echo "ðŸŽ‰ ATUALIZAÃ‡ÃƒO IBAMA CONCLUÃDA COM SUCESSO"
          echo "ðŸŽ‰ ========================================="
          echo "ðŸ“… Data/Hora: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸƒ ExecuÃ§Ã£o: #${{ github.run_number }}"
          echo "ðŸ“Š Dados atualizados no Supabase"
          echo "ðŸ”— Dashboard: https://ibamadashboard.streamlit.app"
          
      - name: âŒ Debug de falha  
        if: failure()
        run: |
          echo "ðŸ’¥ ==============================="
          echo "ðŸ’¥ FALHA NA ATUALIZAÃ‡ÃƒO DOS DADOS"
          echo "ðŸ’¥ ==============================="
          echo "ðŸ“… Falha em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸƒ ExecuÃ§Ã£o: #${{ github.run_number }}"
          echo ""
          echo "ðŸ” PossÃ­veis causas:"
          echo "   â€¢ Incompatibilidade de schema entre CSV e Supabase"
          echo "   â€¢ Problema de conectividade com IBAMA"
          echo "   â€¢ Limite de API do Supabase atingido"
          echo "   â€¢ Dados corrompidos no arquivo ZIP"
          echo ""
          echo "ðŸ› ï¸ Para investigar:"
          echo "   1. Verifique os logs em 'Actions > Artifacts'"
          echo "   2. Execute o workflow em modo debug"
          echo "   3. Verifique o schema da tabela Supabase"
          echo ""
          echo "ðŸ“§ Se o problema persistir, verifique:"
          echo "   â€¢ Schema das colunas no Supabase"
          echo "   â€¢ Limites de rate limiting"
          echo "   â€¢ Conectividade com dadosabertos.ibama.gov.br"
